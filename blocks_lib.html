<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>run_blocks demo</title>
<link rel="stylesheet" href="blocks_lib.css">
<style>
  /* Example-specific styles */
  html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 16px/1.35 system-ui, Segoe UI, Roboto, Arial; }
  /* give containers explicit heights so the SVG (100%) has room */
  #app1 { height: 620px; }
  #app2 { height: 360px; }
  #app3 { height: 700px; }
  #app4 { height: 640px; }

  /* dashed strokes for feedback loop */
  .dash { stroke-dasharray: 8 6; }

/* Optional stroke classes if you want to use className instead of direct color */
.c-motor   { stroke: rgb(171,71,188); }
.c-motor2  { stroke: rgb(186,104,200); }
.c-sens1   { stroke: rgb(77,182,172); }
.c-sens2   { stroke: rgb(3,169,244); }
.c-cereb   { stroke: rgb(240,98,146); }
.c-basal   { stroke: rgb(245,127,23); }
.c-thal    { stroke: rgb(1,87,155); }
.c-olf     { stroke: rgb(56,142,60); }

</style>
</head>
<body>
<div class="wrap">
  <h2>run_blocks demo</h2>
  <div id="app1" class="canvas"></div>
  <div id="app2" class="canvas"></div>
  <div id="app3" class="canvas"></div>
  <div id="app4" class="canvas"></div>
</div>

<!-- ======== Drop-in library (IIFE) ======== -->
<script src="blocks_lib.js"></script>
<!-- ======== /library ======== -->

<!-- ======== Example usage ======== -->
<script>
  // Diagram 1 — Neuro flow (your full example)
  run_blocks("#app1", (b) => {
    // blocks
    b.addBlock("A", 390,  30, 220,  80, "Motor Cortex");
    b.addBlock("B", 390, 130, 220,  80, "Corticospinal Tract");
    b.addBlock("C", 360, 230, 280,  80, "Spinal Cord<br/>Lower Motor Neurons");
    b.addBlock("D", 390, 330, 220,  80, "Peripheral Nerves");
    b.addBlock("E", 390, 430, 220,  80, "Muscles");
    b.addBlock("F", 340, 540, 320,  80, "Movement & Sensory Feedback");
    b.addBlock("G",  70, 540, 260,  80, "Spinal Cord Feedback");
    b.addBlock("H", 720, 280, 220, 110, "Thalamus");
    b.addBlock("I",  70, 130, 200,  80, "Pons");
    b.addBlock("J",  70, 230, 200,  80, "Cerebellum");
    b.addBlock("K", 720,  70, 220,  80, "Basal Ganglia");
    b.addBlock("L", 720, 430, 220,  80, "Olfactory Input");

    const c = b.colors;
    // cortex loop
    [["A","B"],["B","C"],["C","D"],["D","E"]].forEach(([s,e])=>{
      b.connect({start:{block:s,edge:"bottom",t:0}, end:{block:e,edge:"top",t:0}, width:3, sparks:3, sparkSpeed:0.8, color:c.motor});
    });
    // sensory feedback
    b.connect({start:{block:"E",edge:"bottom",t:0}, end:{block:"F",edge:"top",t:0}, width:3, sparks:3, sparkSpeed:0.8, color:c.sens1});
    b.connect({start:{block:"F",edge:"left",t:0},  end:{block:"G",edge:"right",t:0}, width:3, sparks:2, sparkSpeed:0.7, color:c.sens2});
    b.connect({start:{block:"F",edge:"right",t:0}, end:{block:"H",edge:"bottom",t:0}, width:3, sparks:2, sparkSpeed:0.7, color:c.sens2});
    // cerebellum loop
    b.connect({start:{block:"A",edge:"left", t:-0.2}, end:{block:"I",edge:"right",t:-0.2}, width:3, sparks:3, sparkSpeed:0.8, color:c.cereb});
    b.connect({start:{block:"I",edge:"bottom",t:0},  end:{block:"J",edge:"top",  t:0},    width:3, sparks:3, sparkSpeed:0.8, color:c.cereb});
    b.connect({start:{block:"J",edge:"right", t:0},  end:{block:"H",edge:"left", t:-0.1}, width:3, sparks:3, sparkSpeed:0.8, color:c.cereb});
    // basal -> thalamus
    b.connect({start:{block:"K",edge:"bottom",t:0}, end:{block:"H",edge:"top",t:0}, width:3, sparks:3, sparkSpeed:0.8, color:c.basal});
    // thalamus -> motor cortex
    b.connect({start:{block:"H",edge:"right",t:0}, end:{block:"A",edge:"right",t:0}, width:3, sparks:4, sparkSpeed:0.9, color:c.thal});
    // olfactory -> motor
    b.connect({start:{block:"L",edge:"left",t:0}, end:{block:"A",edge:"bottom",t:0.3}, width:3, sparks:3, sparkSpeed:0.8, color:c.olf});
    
    // Test emitter mode with random spark spawning
    b.connect({start:{block:"A",edge:"right",t:0.3}, end:{block:"H",edge:"left",t:0.3}, width:4, sparks:8, sparkSpeed:0.8, color:c.thal, emitter:true, emitMult:0.1, maxLive:0});
  }, { width: 1000, height: 620 });

  // Diagram 2 — tiny toy graph loaded via JSON option
  const app2Spec = {
    "blocks": [
      { "id": "X", "x": 60,  "y": 40, "w": 160, "h": 60, "label": "Input" },
      { "id": "Y", "x": 300, "y": 40, "w": 160, "h": 60, "label": "Processor" },
      { "id": "Z", "x": 540, "y": 40, "w": 160, "h": 60, "label": "Output" }
    ],
    "connections": [
      {
        "start": { "block": "X", "edge": "right", "t": 0 },
        "end":   { "block": "Y", "edge": "left",  "t": 0 },
        "width": 3,
        "sparks": 2,
        "spark_speed": 0.9,
        "color": "motor"
      },
      {
        "start": { "block": "Y", "edge": "right", "t": 0 },
        "end":   { "block": "Z", "edge": "left",  "t": 0 },
        "width": 3,
        "sparks": 2,
        "spark_speed": 0.9,
        "color": "sens2"
      },
      {
        "start": { "block": "Z", "edge": "bottom", "t": 0 },
        "end":   { "block": "X", "edge": "bottom", "t": 0 },
        "width": 4,
        "sparks": 6,
        "spark_speed": 1.0,
        "color": "cereb",
        "emitter": true,
        "emit_mult": 2.0,
        "max_live": 10
      }
    ]
  };

  run_blocks("#app2", null, {
    width: 760,
    height: 360,
    json: app2Spec
  });

  // Diagram 3 — Port of the Python "thalamus/cortex + sensory/motor" scene
  run_blocks("#app3", (b) => {
    // --- Colors (Python palette) ---
    const EAR_COLOR1        = "rgb(27,94,32)";
    const EYE_COLOR1        = "rgb(1,87,155)";
    const SKIN_COLOR1       = "rgb(245,127,23)";

    const EAR_COLOR2        = "rgb(56,142,60)";
    const EYE_COLOR2        = "rgb(2,136,209)";
    const SKIN_COLOR2       = "rgb(251,192,45)";

    const EAR_COLOR3        = "rgb(77,182,172)";
    const EYE_COLOR3        = "rgb(3,169,244)";

    const EYE_EAR_COLOR     = "rgb(79,195,247)";
    const EYE_COLOR4        = "rgb(100,181,246)";

    const MOTOR_AREA_COLOR1 = "rgb(171,71,188)";
    const MOTOR_AREA_COLOR2 = "rgb(186,104,200)";

    const COGNITIVE_COLOR4  = "rgb(136,14,79)";
    const COGNITIVE_COLOR3  = "rgb(194,24,91)";
    const COGNITIVE_COLOR2  = "rgb(233,30,99)";
    const COGNITIVE_COLOR1  = "rgb(240,98,146)";

    const ARROW_COLOR       = b.colors.arrow; // from library palette

    // --- Blocks (coordinates mirror Python layout) ---
    const a = b.addBlock("A", 460,  50, 400, 200, "Thalamus");
    const c1= b.addBlock("B", 330, 360, 100, 400, "Cortex");
    const ear = b.addBlock("Ear", 10,  50, 100, 100, "Ear");
    const skin= b.addBlock("Skin",10, 200, 100, 100, "Skin");
    const eye = b.addBlock("Eye", 10, 350, 100, 100, "Eye");
    const move= b.addBlock("Move",10, 500, 100, 100, "Movement");
    // notes → render on topmost layer
    b.addBlock("NoteSorted", 560, 300, 200, 100, "Topographically sorted", { note: true });
    b.addBlock("NoteBrain",  610, 690, 280, 100, "Data flow in the human brain", { note: true });

    // helper for slight randomness like the Python version
    const rnd = () => Math.random();

    // collect connections here (not necessary, but mirrors structure)
    const add = (opts) => b.connect(opts);

    // --- Sensory input: Ear/Eye/Skin/Movement -> Thalamus (left) with offsets & randomized end t ---
    for (const t of [-0.4, 0.0, 0.4]) {
      add({ start:{block:"Ear", edge:"right", t},  end:{block:"A", edge:"left",  t:-0.5 + rnd()}, color: EAR_COLOR1, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4 });
      add({ start:{block:"Eye", edge:"right", t},  end:{block:"A", edge:"left",  t:-0.5 + rnd()}, color: EYE_COLOR1, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4 });
      add({ start:{block:"Skin",edge:"right", t},  end:{block:"A", edge:"left",  t:-0.5 + rnd()}, color: SKIN_COLOR1, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4 });
      add({ start:{block:"Move",edge:"right", t},  end:{block:"A", edge:"left",  t:-0.5 + rnd()}, color: MOTOR_AREA_COLOR1, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4 });
    }

    // --- Cortex -> Cortex: a few lateral internal edges with random offsets ---
    for (let i=0;i<5;i++){
      add({
        start:{block:"B", edge:"left",  t:-0.5 + rnd()},
        end:  {block:"B", edge:"right", t:-0.5 + rnd()},
        color: ARROW_COLOR, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4
      });
    }

    // --- Thalamus -> Cortex (15 areas) ---
    const thalToCtxColors = [
      EYE_COLOR1, EYE_COLOR2, EYE_COLOR3, EYE_COLOR4, EYE_EAR_COLOR,
      EAR_COLOR3, EAR_COLOR2, EAR_COLOR1, SKIN_COLOR2, SKIN_COLOR1,
      MOTOR_AREA_COLOR1, COGNITIVE_COLOR1, COGNITIVE_COLOR2, COGNITIVE_COLOR3, COGNITIVE_COLOR4
    ];
    const perArea = 1;
    thalToCtxColors.forEach((col, idx) => {
      const area = idx / 15 + 0.05;
      for (let t=0; t<perArea; t++){
        const lane = 0.5 - (area + t/30);
        add({
          start:{block:"A", edge:"bottom", t: lane},
          end:  {block:"B", edge:"right",  t: lane},
          color: col, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4
        });
      }
    });

    // --- Cortex -> Thalamus (12 areas) + motor split to Movement ---
    const ctxToThalColors = [
      EYE_COLOR2, EYE_COLOR3, EYE_COLOR4, EYE_EAR_COLOR, EAR_COLOR3, EAR_COLOR2,
      SKIN_COLOR2, MOTOR_AREA_COLOR1, COGNITIVE_COLOR1, COGNITIVE_COLOR2, COGNITIVE_COLOR3, COGNITIVE_COLOR4
    ];
    ctxToThalColors.forEach((col, idx) => {
      const area = idx / 13;
      const lane = 0.4 - (area + 0/26);
      // to thalamus (random end on left side)
      add({
        start:{block:"B", edge:"left",  t: lane},
        end:  {block:"A", edge:"left",  t: -0.5 + rnd()},
        color: col, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4
      });
      // special motor split: to Movement bottom at two lanes
      if (col === MOTOR_AREA_COLOR1) {
        add({
          start:{block:"B", edge:"left",  t: lane},
          end:  {block:"Move", edge:"bottom", t: -0.33},
          color: MOTOR_AREA_COLOR2, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4
        });
        add({
          start:{block:"B", edge:"left",  t: lane},
          end:  {block:"Move", edge:"bottom", t: 0.33},
          color: MOTOR_AREA_COLOR2, width:3, sparks:3, sparkSpeed: 0.7 + rnd()/4
        });
      }
    });
  }, { width: 900, height: 800 });

  // Diagram 4 — matches the provided figure (Thalamus/Cortex/Monoamine + Sensory/Motor)
  run_blocks("#app4", (b) => {
    const c = b.colors; // palette

    // Top row
    b.addBlock("Thal",   120, 140, 220, 70, "Thalamus");
    b.addBlock("Ctx",    380, 140, 240, 70, "Cortex");
    b.addBlock("MA",     670, 140, 260, 70, "Monoamine\nNeurons");

    // Bottom row
    b.addBlock("Sens",   120, 480, 220, 70, "Sensory\nNeurons");
    b.addBlock("Motor",  520, 480, 220, 70, "Motor\nNeurons");

    // Two central pathway bars (thin unlabeled)
    b.addBlock("Bar1",   430, 320, 220, 22, "", { note: true });
    b.addBlock("Bar2",   430, 360, 220, 22, "", { note: true });
    // Make the bars look like white slats (lighter than nodes)
    for (const id of ["Bar1","Bar2"]) {
      const blk = b.block(id);
      blk.rect.setAttribute("fill", "#e6ebf0");
      blk.rect.setAttribute("stroke", "none");
      blk.text.style.display = "none";
    }

    // ----- Notes / labels (topmost) -----
    const nTopo = b.addBlock("NoteTopo", 210, 60, 220, 28, "Topographically sorted signal", { note: true });
    const nRL   = b.addBlock("NoteRL",   690, 60, 260, 40, "Reinforcement Learning\n(modulatory signal)", { note: true });
    const nHO   = b.addBlock("NoteHO",    20, 250, 250, 26, "Higher-Order Sensory Input", { note: true });
    const nSI   = b.addBlock("NoteSI",    20, 330, 160, 26, "Sensory Input", { note: true });
    // Make note blocks text-only (no rectangle box)
    for (const id of ["NoteTopo","NoteRL","NoteHO","NoteSI"]) {
      const nb = b.block(id);
      nb.rect.setAttribute("fill", "none");
      nb.rect.setAttribute("stroke", "none");
    }

    // ----- Arcs/loops on the top row -----
    // Thalamus -> Cortex (topo loop)
    b.connect({
      start:{ block:"Thal", edge:"top", t:  0.22 },
      end:  { block:"Ctx",  edge:"top", t: -0.22 },
      width:3, sparks:3, sparkSpeed:0.7, color: c.arrow
    });
    // Cortex -> Thalamus (return on same loop)
    b.connect({
      start:{ block:"Ctx",  edge:"bottom", t: -0.22 },
      end:  { block:"Thal", edge:"bottom", t: 0.22 },
      width:3, sparks:3, sparkSpeed:0.7, color: c.arrow
    });
    // Label leader from note to the loop (thin)
    b.connect({
      start:{ block:"NoteTopo", edge:"bottom", t: 0 },
      end:  { block:"Ctx", edge:"top", t: 0.0 },
      width:2, sparks:0, color:c.arrow
    });

    // Cortex <-> Monoamine (modulatory RL loop)
    b.connect({
      start:{ block:"Ctx", edge:"bottom", t:  0.22 },
      end:  { block:"MA",  edge:"bottom", t: -0.22 },
      width:3, sparks:2, sparkSpeed:0.6, color: c.arrow
    });
    b.connect({
      start:{ block:"MA",  edge:"top", t: -0.22 },
      end:  { block:"Ctx", edge:"top", t: 0.22 },
      width:3, sparks:2, sparkSpeed:0.6, color: c.arrow
    });
    // Label leader from RL note
    b.connect({
      start:{ block:"NoteRL", edge:"bottom", t: 0 },
      end:  { block:"MA", edge:"top", t: 0.0 },
      width:2, sparks:0, color:c.arrow
    });

    // ----- Sensory side (left) -----
    // Sensory Input -> Sensory Neurons (leftward leader)
    b.connect({
      start:{ block:"NoteSI", edge:"right", t: 0 },
      end:  { block:"Sens",   edge:"left",  t: 0 },
      width:2, sparks:0, color:c.arrow
    });
    // Higher-order sensory -> Thalamus
    b.connect({
      start:{ block:"NoteHO", edge:"right", t: 0 },
      end:  { block:"Thal",   edge:"left",  t: -0.05 },
      width:2, sparks:0, color:c.arrow
    });
    // Sensory Neurons -> Thalamus (vertical)
    b.connect({
      start:{ block:"Sens", edge:"top", t: 0 },
      end:  { block:"Thal", edge:"bottom", t: -0.2 },
      width:3, sparks:3, sparkSpeed:0.7, color:c.arrow
    });

    // ----- Motor pathway (downward from Cortex) -----
    b.connect({ start:{block:"Ctx", edge:"bottom", t: -0.1}, end:{block:"Bar1", edge:"top", t: 0}, width:3, sparks:3, sparkSpeed:0.7, color:c.arrow });
    b.connect({ start:{block:"Bar1", edge:"bottom", t: 0},   end:{block:"Bar2", edge:"top", t: 0}, width:3, sparks:2, sparkSpeed:0.6, color:c.arrow });
    b.connect({ start:{block:"Bar2", edge:"bottom", t: 0},   end:{block:"Motor", edge:"top", t: 0}, width:3, sparks:3, sparkSpeed:0.7, color:c.arrow });

    // Bottom feedback: Motor -> Sensory (dashed arc)
    const dashed = {className: "dash", color: c.arrow, width:3, sparks:3, sparkSpeed:0.7 };
    b.connect({
      ...dashed,
      start:{ block:"Motor", edge:"left", t: 0.0 },
      end:  { block:"Sens",  edge:"right", t: 0.0 }
    });
  }, { width: 1000, height: 640 });
</script>
</body>
</html>
